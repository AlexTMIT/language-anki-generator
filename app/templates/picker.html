<!doctype html>
<title>Choose images – {{ word }}</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mini.css@3/dist/mini-default.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='picker.css') }}">

<div class="container">
  <div class="card card-picker">
    <h4>{{ word }} ({{ trans }}, {{ gram }}) – choose up to 3 images</h4>

    <form id="f" method="post" enctype="multipart/form-data">
      <div class="grid" id="grid">
        {% for u in urls %}
          <label>
            <input type="checkbox" name="url" value="{{ u }}" hidden>
            <img src="{{ u }}">
          </label>
        {% endfor %}
      </div>

      <div class="dropzone" id="dz">
        ⇧ Drag images here or paste (⌘V / Ctrl-V) ⇧
        <input type="file" id="file" name="file" multiple accept="image/*" hidden>
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="ghost"   type="submit" name="action" value="skip">Skip</button>
        <button class="primary" type="submit" name="action" value="keep" id="btn" disabled>
          Continue
        </button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='picker.js') }}"></script>
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script>
  const grid = document.querySelector('#grid');
  const msnry = new Masonry(grid, {
    itemSelector: 'label',
    gutter: 12,
    fitWidth: true
  });

  // Ensure layout updates after images load
  imagesLoaded(grid, () => msnry.layout());

  // Utility to append new image
  function addImage(src) {
    const label = document.createElement('label');
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.name = 'url';
    input.hidden = true;
    input.value = src;

    const img = document.createElement('img');
    img.src = src;

    label.appendChild(input);
    label.appendChild(img);
    grid.appendChild(label);

    imagesLoaded(label, () => {
      msnry.appended(label);
      msnry.layout();
    });
  }

  // Example hook: handle pasted images
  document.addEventListener('paste', e => {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.type.indexOf('image') === 0) {
        const blob = item.getAsFile();
        const reader = new FileReader();
        reader.onload = e => addImage(e.target.result);
        reader.readAsDataURL(blob);
      }
    }
  });

  // Handle dropped images
  document.getElementById('dz').addEventListener('drop', e => {
    e.preventDefault();
    for (const file of e.dataTransfer.files) {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = e => addImage(e.target.result);
        reader.readAsDataURL(file);
      }
    }
  });
</script>